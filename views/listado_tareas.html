<!doctype html>
<html lang="es">
<head>
Â  Â  <meta charset="utf-8" />
Â  Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  Â  <title>Listado de Tareas - AppTareas</title>
Â  Â Â 
Â  Â  <link rel="stylesheet" href="../styles.css">
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  /* Estilos existentes (mantener) */
Â  Â  Â  Â  .task-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  background: var(--bg-secondary);
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow-sm);
Â  Â  Â  Â  }
Â  Â  Â  Â  .task-item.iso { border-left: 5px solid var(--color-accent); }
Â  Â  Â  Â  .task-item.general { border-left: 5px solid var(--color-accent-dark); }
Â  Â  Â  Â  .task-item.done {
Â  Â  Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  Â  Â  Â  border-left: 5px solid var(--color-text-secondary);Â 
Â  Â  Â  Â  Â  Â  text-decoration: line-through;
Â  Â  Â  Â  }
Â  Â  Â  Â  .task-details { flex-grow: 1; }
Â  Â  Â  Â  .task-details h3 { margin: 0; font-size: 1.1em; color: var(--color-text-primary); }
Â  Â  Â  Â  .task-details p { margin: 4px 0 0; font-size: 0.9em; color: var(--color-text-secondary); }
Â  Â  Â  Â  .task-status {
Â  Â  Â  Â  Â  Â  font-weight: 700; padding: 5px 10px; border-radius: 5px; font-size: 0.8em;
Â  Â  Â  Â  Â  Â  color: white; white-space: nowrap; margin-left: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-pending { background: #d46a1c; }
Â  Â  Â  Â  .status-done { background: var(--color-text-secondary); }
Â  Â  Â  Â  .task-source { font-size: 0.75em; font-style: italic; color: var(--color-accent); margin-top: 5px; }

Â  Â  Â  Â  /* ğŸ¨ ESTILOS PARA EL BOTÃ“N DE ELIMINACIÃ“N/COMPLETADO (VERDE) ğŸ¨ */
        /* Nota: Aunque pediste que diga "Completar", la acciÃ³n es eliminar, por eso te doy un color de confirmaciÃ³n */
Â  Â  Â  Â  .action-complete-button {
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  background-color: #4CAF50; /* Verde */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .action-complete-button:hover {
Â  Â  Â  Â  Â  Â  background-color: #45a049;
Â  Â  Â  Â  }
Â  Â  Â  Â  .action-complete-button:disabled {
Â  Â  Â  Â  Â  Â  background-color: #ccc;
Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â Â 
Â  Â  <header class="site-nav">
Â  Â  Â  Â  <div style="font-size: 1.2em; font-weight: bold;">AppTareas | Listado</div>
Â  Â  Â  Â  <nav class="nav-links">
Â  Â  Â  Â  Â  Â  <a href="../index.html">â† Volver al Inicio</a>
Â  Â  Â  Â  </nav>
Â  Â  </header>

Â  Â  <div class="container">

Â  Â  Â  Â  <h1>Listado Consolidado de Tareas</h1>
Â  Â  Â  Â  <p class="optional">Muestra tareas creadas desde el gestor ISO (local) y tareas creadas desde la pÃ¡gina principal (obtenidas de la base de datos).</p>

Â  Â  Â  Â  <section class="card">
Â  Â  Â  Â  Â  Â  <h2>Tareas Registradas por Origen</h2>
Â  Â  Â  Â  Â  Â  <div id="taskListContainer">
Â  Â  Â  Â  Â  Â  Â  Â  <p>Cargando tareas...</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â Â 
Â  Â  </div>
Â  Â Â 
Â  Â  <footer>
Â  Â  Â  Â  &copy; 2025 AppTareas. Todos los derechos reservados.
Â  Â  </footer>

Â  Â  <script src="../security.js"></script>
Â  Â  <script>
        // ğŸš€ FUNCIÃ“N PARA EL BOTÃ“N (AHORA ELIMINA) ğŸš€
        async function toggleTaskCompletion(taskId) {
            if (!taskId || taskId === 'undefined') {
                console.error("Error: Task ID es nulo o indefinido.");
                alert("No se pudo identificar la tarea.");
                return;
            }

            const taskElement = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
            const button = taskElement ? taskElement.querySelector('.action-complete-button') : null;
            
            // 1. Feedback visual inmediato
            if (button) {
                button.disabled = true;
                button.textContent = 'Borrando...';
            }

            try {
                // 2. ğŸ”‘ CLAVE: Usamos mÃ©todo DELETE y la URL corregida a /tareas/:id
                const response = await fetch(`/tareas/${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    // Si el servidor responde 404 es posible que ya haya sido eliminada o ID incorrecto
                    if (response.status !== 404) { 
                         throw new Error(`Error ${response.status} en el servidor.`);
                    }
                }

                // 3. EliminaciÃ³n exitosa: Quitamos el elemento del DOM
                if (taskElement) {
                    taskElement.remove();
                    console.log(`Tarea ${taskId} eliminada y removida del DOM.`);
                }
                
            } catch (error) {
                console.error('Fallo al eliminar la tarea:', error);
                alert('Hubo un error de conexiÃ³n o de servidor. Intenta de nuevo.');

                // 4. Revertir el estado del botÃ³n en caso de fallo
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Completar'; 
                }
            }
        }
        // ---------------------------------
        
        document.addEventListener('DOMContentLoaded', async function() {
            const container = document.getElementById('taskListContainer');
            const SESSION_KEY = 'isAuthenticated';

            if (!container) {
                console.error("Error Fatal: El elemento con ID 'taskListContainer' no se encontrÃ³. Verificar el HTML.");
                return; 
            }

            if (typeof security_getAllConsolidatedTasks === 'undefined') {
                container.innerHTML = '<p style="color:red">Error: La funciÃ³n de consolidaciÃ³n de tareas no estÃ¡ disponible. AsegÃºrate de que security.js estÃ© actualizado.</p>';
                return;
            }

            if (localStorage.getItem(SESSION_KEY) !== 'true') {
                container.innerHTML = '<p class="optional" style="color:#d46a1c; font-weight:bold;">Acceso Denegado: Debes iniciar sesiÃ³n primero en la pÃ¡gina de <a href="../index.html">Inicio</a> para ver las tareas del servidor.</p>';
                return; 
            }
            
            container.innerHTML = '<p class="optional">Cargando tareas desde el servidor...</p>';
            
            const tasks = await window.security_getAllConsolidatedTasks(); 
            container.innerHTML = ''; 

            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<p class="optional">No tienes tareas registradas todavÃ­a o hubo un problema de sesiÃ³n/conexiÃ³n.</p>';
                return;
            }

            tasks.forEach(t => {
                const taskId = t._id || t.id; // Soporte para Mongoose (_id) o ID normalizado
                
                if (!taskId) {
                    console.warn("Tarea omitida por falta de ID:", t);
                    return; 
                }
                
                const isDone = t.status === 'done';
                const statusText = isDone ? 'COMPLETADA' : 'PENDIENTE';
                const statusClass = isDone ? 'status-done' : 'status-pending';
                const typeClass = t.type || 'general';

                const item = document.createElement('div');
                item.dataset.taskId = taskId; 
                item.className = `task-item ${isDone ? 'done' : ''} ${typeClass}`;
                
                const isoInfo = t.type === 'iso' ? `<p style="font-size: 0.8em;">Fase ISO: ${t.phase || 'N/A'}</p>` : '';
                
                const formattedDate = t.due ? `Vencimiento: ${t.due}` : `Creado: ${new Date(t.ts || t.fechaCreacion).toLocaleDateString()}`;

                // ğŸ”‘ BotÃ³n solo visible si NO es una tarea ISO
                const buttonHTML = (t.source !== 'ISO (Local)') ? 
                    `<button
                        class="action-complete-button"
                        onclick="toggleTaskCompletion('${taskId}')"
                    >
                        Completar
                    </button>`
                    : '';
                
                item.innerHTML = `
                    <div class="task-details">
                        <h3>${window.security_escapeHTML(t.title)}</h3>
                        <p>${window.security_escapeHTML(t.desc || 'Sin descripciÃ³n')}</p>
                        ${isoInfo}
                        <div class="task-source">Origen: ${t.source || 'DB'} (${formattedDate})</div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                        <div id="status-display-${taskId}" class="task-status ${statusClass}">
                            ${statusText}
                        </div>
                        ${buttonHTML}
                    </div>
                `;
                container.appendChild(item);
            });
        });
Â  Â  </script>
</body>
</html>